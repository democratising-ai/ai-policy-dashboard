<div class="form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ isEditMode() ? 'edit' : 'add' }}</mat-icon>
        {{ isEditMode() ? 'Edit Policy Entry' : 'Add New Policy Entry' }}
      </mat-card-title>
      <mat-card-subtitle>
        {{ tableType() === 'tableA' ? 'Table A' : 'Table B' }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Authentication Status -->
      @if (!isAuthenticated()) {
        <div class="auth-status">
          <mat-icon color="warn">warning</mat-icon>
          <span>You need to authenticate with GitHub to submit forms.</span>
          <button mat-button color="primary" (click)="authenticate()">
            Authenticate
          </button>
        </div>
      }

      @if (isAuthenticated()) {
        <div class="auth-status authenticated">
          <mat-icon color="primary">check_circle</mat-icon>
          <span>Authenticated as: {{ currentUser()?.login }}</span>
          <button mat-button color="warn" (click)="logout()" class="logout-btn">
            <mat-icon>logout</mat-icon>
            Logout
          </button>
        </div>
      }

      <!-- Loading State -->
      @if (loading()) {
        <div class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Loading form...</p>
        </div>
      }

      <!-- Form -->
      @if (!loading() && form) {
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          <div class="form-grid">
            @for (column of columns(); track column.id) {
              <!-- Checkbox fields (outside mat-form-field) -->
              @if (getFieldType(column) === 'checkbox') {
                <div class="checkbox-field">
                  <mat-checkbox [formControlName]="column.id">
                    {{ getFieldLabel(column) }}
                  </mat-checkbox>
                </div>
              }

              <!-- All other fields (inside mat-form-field) -->
              @if (getFieldType(column) !== 'checkbox') {
                <!-- Select/Dropdown (only when options exist) -->
                @if ((getFieldType(column) === 'select' || getFieldType(column) === 'lookup') && !column.format.isArray && hasSelectOptions(column)) {
                  <mat-form-field
                    appearance="outline"
                    [class.required]="isFieldRequired(column)">
                    <mat-label>{{ getFieldLabel(column) }}</mat-label>
                    <mat-select
                      [formControlName]="column.id"
                      [required]="isFieldRequired(column)"
                      placeholder="Select">
                      @for (option of getSelectOptions(column); track option) {
                        <mat-option [value]="option">
                          {{ option }}
                        </mat-option>
                      }
                    </mat-select>
                    @if (form.get(column.id)?.hasError('required')) {
                      <mat-error>
                        {{ getFieldLabel(column) }} is required
                      </mat-error>
                    }
                  </mat-form-field>
                }

                <!-- Text input fallback for select/lookup with no options -->
                @if ((getFieldType(column) === 'select' || getFieldType(column) === 'lookup') && !column.format.isArray && !hasSelectOptions(column)) {
                  <mat-form-field
                    appearance="outline"
                    [class.required]="isFieldRequired(column)">
                    <mat-label>{{ getFieldLabel(column) }}</mat-label>
                    <input
                      matInput
                      [formControlName]="column.id"
                      [required]="isFieldRequired(column)"
                    />
                    @if (form.get(column.id)?.hasError('required')) {
                      <mat-error>
                        {{ getFieldLabel(column) }} is required
                      </mat-error>
                    }
                  </mat-form-field>
                }

                <!-- Number Input -->
                @if (getFieldType(column) === 'number') {
                  <mat-form-field
                    appearance="outline"
                    [class.required]="isFieldRequired(column)">
                    <mat-label>{{ getFieldLabel(column) }}</mat-label>
                    <input
                      matInput
                      type="number"
                      [formControlName]="column.id"
                      [required]="isFieldRequired(column)"
                    />
                    @if (form.get(column.id)?.hasError('required')) {
                      <mat-error>
                        {{ getFieldLabel(column) }} is required
                      </mat-error>
                    }
                  </mat-form-field>
                }

                <!-- Textarea for long text fields -->
                @if (getFieldType(column) === 'text' && !column.format.isArray && (column.name.length > 50 || column.name.toLowerCase().includes('reason') || column.name.toLowerCase().includes('description') || column.name.toLowerCase().includes('note'))) {
                  <mat-form-field
                    appearance="outline"
                    [class.required]="isFieldRequired(column)">
                    <mat-label>{{ getFieldLabel(column) }}</mat-label>
                    <textarea
                      matInput
                      [formControlName]="column.id"
                      rows="3"
                      [required]="isFieldRequired(column)"
                    ></textarea>
                    @if (form.get(column.id)?.hasError('required')) {
                      <mat-error>
                        {{ getFieldLabel(column) }} is required
                      </mat-error>
                    }
                  </mat-form-field>
                }

                <!-- Array fields - text input with comma-separated values -->
                @if (column.format.isArray) {
                  <mat-form-field
                    appearance="outline"
                    [class.required]="isFieldRequired(column)">
                    <mat-label>{{ getFieldLabel(column) }}</mat-label>
                    <input
                      matInput
                      [formControlName]="column.id"
                      [required]="isFieldRequired(column)"
                      placeholder="Comma-separated values"
                    />
                    <mat-hint>Enter comma-separated values</mat-hint>
                    @if (form.get(column.id)?.hasError('required')) {
                      <mat-error>
                        {{ getFieldLabel(column) }} is required
                      </mat-error>
                    }
                  </mat-form-field>
                }

                <!-- Default text input for all other types -->
                @if (getFieldType(column) !== 'checkbox' && getFieldType(column) !== 'number' && getFieldType(column) !== 'select' && getFieldType(column) !== 'lookup' && !column.format.isArray && !(getFieldType(column) === 'text' && (column.name.length > 50 || column.name.toLowerCase().includes('reason') || column.name.toLowerCase().includes('description') || column.name.toLowerCase().includes('note')))) {
                  <mat-form-field
                    appearance="outline"
                    [class.required]="isFieldRequired(column)">
                    <mat-label>{{ getFieldLabel(column) }}</mat-label>
                    <input
                      matInput
                      [formControlName]="column.id"
                      [required]="isFieldRequired(column)"
                    />
                    @if (form.get(column.id)?.hasError('required')) {
                      <mat-error>
                        {{ getFieldLabel(column) }} is required
                      </mat-error>
                    }
                  </mat-form-field>
                }
              }
            }
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button
              mat-button
              type="button"
              (click)="cancel()"
              [disabled]="submitting()"
            >
              Cancel
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="form.invalid || submitting() || !isAuthenticated()"
            >
              @if (submitting()) {
                <mat-spinner diameter="20" class="button-spinner"></mat-spinner>
                <span>Submitting...</span>
              } @else {
                <span>{{ isEditMode() ? 'Update' : 'Submit' }}</span>
              }
            </button>
          </div>
        </form>
      }
    </mat-card-content>
  </mat-card>
</div>
