<div class="policy-analysis-container">
  <h2>Table A: All Potentially Relevant AI Policies Reviewed</h2>

  <!-- Loading state -->
  @if (loading()) {
    <div class="loading-state">
      <mat-spinner></mat-spinner>
      <p>Loading policy data...</p>
    </div>
  }

  <!-- Error state -->
  @if (error() && !loading()) {
    <div class="error-state">
      <p>{{ error() }}</p>
      <button mat-raised-button (click)="loadData()">Retry</button>
    </div>
  }

  <!-- Data table -->
  @if (data() && !loading()) {
    <div class="table-section">
      <!-- Add New Button -->
      <div class="action-bar">
        <button mat-raised-button color="primary" routerLink="/data/policy-form/tableA">
          <mat-icon>add</mat-icon>
          Add New Entry
        </button>
      </div>

      <!-- Controls -->
      <div class="table-controls">
        <div class="control-group">
          <h3>Columns ({{ visibleColumns().length }}/{{ data()!.columns.length }})</h3>
          <div class="button-group">
            <button mat-button (click)="toggleAllColumns(true)">Show All</button>
            <button mat-button (click)="toggleAllColumns(false)">Hide All</button>
          </div>
        </div>

        <details class="column-selector">
          <summary>Customize Columns</summary>
          <div class="column-grid">
            @for (column of data()!.columns; track column.id) {
              <mat-checkbox
                [checked]="!hiddenColumnIds().has(column.id)"
                (change)="toggleColumn(column.id)"
                (click)="$event.stopPropagation()">
                {{ column.name }}
              </mat-checkbox>
            }
          </div>
        </details>
      </div>

      <!-- Table -->
      <div class="table-wrapper">
        <mat-paginator
          [pageSizeOptions]="[10, 25, 50, 100]"
          [pageSize]="25"
          showFirstLastButtons
          aria-label="Select page">
        </mat-paginator>
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">

          <!-- Dynamic Column Definitions -->
          @for (column of visibleColumns(); track column.id) {
            <ng-container [matColumnDef]="column.name">
              <th mat-header-cell *matHeaderCellDef
                  [class.sorted]="getSortDirection(column.name) !== null"
                  [class.sorted-asc]="getSortDirection(column.name) === 'asc'"
                  [class.sorted-desc]="getSortDirection(column.name) === 'desc'"
                  class="clickable-header">
                <div class="header-content">
                  <div class="header-sort-area"
                       (click)="onColumnHeaderClick(column, $event)"
                       [matTooltip]="getSortTooltip(column.name)"
                       matTooltipPosition="below">
                    <div class="header-text">
                      <span>{{ column.name }}</span>
                      @if (getSortDirection(column.name) === 'asc') {
                        <mat-icon class="sort-icon">arrow_upward</mat-icon>
                      } @else if (getSortDirection(column.name) === 'desc') {
                        <mat-icon class="sort-icon">arrow_downward</mat-icon>
                      } @else {
                        <mat-icon class="sort-hint-icon">unfold_more</mat-icon>
                      }
                    </div>
                  </div>
                  <button type="button"
                          class="close-button"
                          (click)="toggleColumn(column.id); $event.stopPropagation()"
                          title="Hide this column"
                          aria-label="Hide this column">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </th>

              <td mat-cell *matCellDef="let row">
                @if (!isLink(column)) {
                  {{ formatCellValue(getCellValue(row, column.name), column) }}
                }

                @if (isLink(column) && getCellValue(row, column.name)) {
                  <a [href]="getSafeUrl(row, column.name)"
                    target="_blank"
                    rel="noopener noreferrer"
                    mat-button
                    color="primary">
                    View Link
                  </a>
                }

                @if (isLink(column) && !getCellValue(row, column.name)) {
                  <span>-</span>
                }
              </td>
            </ng-container>
          }

          <tr mat-header-row *matHeaderRowDef="displayedColumns(); sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns()"
              (click)="onRowClick(row)"
              class="hoverable-row">
          </tr>
        </table>
      </div>

      <!-- Summary -->
      <div class="table-summary">
        <p>Showing {{ dataSource.data.length }} rows with {{ visibleColumns().length }} columns</p>
      </div>
    </div>
  }
</div>
